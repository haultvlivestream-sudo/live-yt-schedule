name: "3. Live Schedule (TES JAM 15:21 WIB)"

on:
  schedule:
    # 15:21 WIB = 08:21 UTC
    - cron: '21 8 * * *'
  workflow_dispatch: # Supaya bisa dijalankan manual juga

jobs:
  streaming:
    runs-on: ubuntu-latest
    steps:
      - name: Install Tooling
        run: |
          sudo apt update && sudo apt install ffmpeg jq -y
          sudo curl -L https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp -o /usr/local/bin/yt-dlp
          sudo chmod a+rx /usr/local/bin/yt-dlp

      - name: Persiapan & Start Live
        run: |
          set +e 
          
          # Ambil Cookies dari Secrets
          echo "${{ secrets.YT_COOKIES }}" > cookies.txt
          
          # Unduh logo
          LINK_LOGO="https://youtu.be/zR6n39ZWrJM"
          yt-dlp --cookies cookies.txt -f "best" --merge-output-format mp4 "$LINK_LOGO" -o logo_video.mp4

          echo "Sistem Standby... Menunggu jadwal otomatis 15:21 WIB..."
          
          while true; do
            # Ambil URL Video dari Secrets
            VIDEO_URL=$(yt-dlp --cookies cookies.txt -f "best[height<=720]" -g "${{ secrets.LINK_SUMBER }}" 2>/dev/null)

            if [ -z "$VIDEO_URL" ]; then
              echo "Sumber belum ketemu, cek lagi dalam 10 detik..."
              sleep 10
              continue
            fi

            echo "ðŸš€ Sumber ditemukan! Memulai FFmpeg..."

            ffmpeg -re -i "$VIDEO_URL" \
              -stream_loop -1 -i logo_video.mp4 \
              -filter_complex "[1:v]colorkey=0x008100:0.1:0.1,scale=75:-1[logo]; [0:v][logo]overlay=W-w-15:15:shortest=1" \
              -c:v libx264 -preset veryfast -b:v 2500k \
              -c:a aac -ar 44100 -b:a 128k \
              -f flv "rtmp://a.rtmp.youtube.com/live2/${{ secrets.STREAM_KEY }}"

            echo "FFmpeg berhenti. Mencoba restart dalam 2 detik..."
            sleep 2
          done
